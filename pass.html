<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Floptropican Passport PDF Generator</title>

<!-- html2pdf bundle (includes html2canvas & jsPDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --passport-width: 850px; /* preview width */
  }

  body{
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    margin: 20px;
    background: #f3f4f6;
    color: #111827;
  }

  h1 { margin-bottom: 6px; font-size: 20px; }
  p.lead { margin-top:0; color:#374151; }

  .layout{
    display:flex;
    gap:18px;
    align-items:flex-start;
    flex-wrap:wrap;
  }

  .controls{
    min-width:280px;
    max-width:360px;
    background:#fff;
    padding:14px;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(0,0,0,0.06);
  }

  label{ display:block; margin-top:10px; font-weight:600; font-size:13px; }
  input[type="text"], input[type="date"], input[type="file"], select {
    width:100%;
    margin-top:6px;
    padding:8px 10px;
    border-radius:6px;
    border:1px solid #d1d5db;
    box-sizing:border-box;
  }

  .btn{
    display:inline-block;
    margin-top:12px;
    padding:10px 14px;
    background:#0b74ff;
    color:white;
    border-radius:8px;
    cursor:pointer;
    border:0;
    font-weight:700;
  }

  .btn.secondary{
    background:#6b7280;
  }

  /* Preview area */
  .preview-wrap{
    width:var(--passport-width);
    max-width:100%;
  }

  .passport-preview{
    width:100%;
    box-shadow:0 12px 30px rgba(2,6,23,0.12);
    border-radius:6px;
    overflow:hidden;
    background: #fff;
  }

  /* Two pages stacked vertically in preview */
  .page{
    width:100%;
    height:1200px; /* approximate A4-ish aspect for preview */
    box-sizing:border-box;
    padding:0;
    position:relative;
    page-break-after:always;
  }

  /* FRONT PAGE STYLING */
  .front {
    display:flex;
    align-items:stretch;
    justify-content:center;
    background: linear-gradient(180deg, rgba(157,187,140,0.15), rgba(157,187,140,0.25));
    /* swampy pastel green */
    background-color: #9fbf86;
    color: #0b2b13;
  }

  /* Place flag images top-left */
  .top-left-flags{
    position:absolute;
    top:20px;
    left:20px;
    display:flex;
    gap:6px;
    z-index:5;
  }
  .top-left-flags img{
    width:58px;
    height:38px;
    object-fit:cover;
    border-radius:4px;
    border:1px solid rgba(0,0,0,0.08);
    background:#fff;
  }

  /* centre coat of arms */
  .coa-wrap{
    display:flex;
    align-items:center;
    justify-content:center;
    width:100%;
    height:calc(100% - 160px);
  }
  .coa-wrap img{
    width:330px;
    height:330px;
    object-fit:contain;
    filter: drop-shadow(0 6px 14px rgba(6,10,7,0.18));
  }

  /* bottom text */
  .front-footer{
    position:absolute;
    bottom:20px;
    width:100%;
    text-align:center;
    padding:0 18px;
  }
  .front-footer .title{
    font-weight:800;
    font-size:20px;
    letter-spacing:1px;
  }
  .front-footer .mandarin{
    margin-top:4px;
    font-weight:600;
    font-size:14px;
    opacity:0.9;
  }

  /* INNER PAGE */
  .inner{
    background:linear-gradient(180deg,#fff,#f8fafc);
    color:#0b1220;
    padding:28px 36px;
    display:flex;
    gap:18px;
  }

  .bio{
    width:40%;
    min-width:260px;
    background:linear-gradient(180deg, rgba(11,17,32,0.02), rgba(11,17,32,0.01));
    padding:16px;
    border-radius:8px;
    border:1px dashed rgba(11,17,32,0.06);
  }

  .photo-box{
    width:100%;
    background: #e6eef0;
    border-radius:6px;
    height:320px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    position:relative;
  }

  /* Important: use background-image to preserve aspect and center-crop */
  .photo-box .photo{
    width:100%;
    height:100%;
    background-position:center;
    background-size:cover;
    background-repeat:no-repeat;
  }

  .data{
    margin-top:12px;
    font-size:14px;
  }
  .data-item{ margin-bottom:8px; display:flex; gap:6px; align-items:center; }
  .data-item .label{ width:110px; color:#374151; font-weight:700; font-size:13px; }
  .data-item .value{ font-weight:800; color:#0b1220; }

  .stamps{
    width:60%;
    padding:12px;
    border-radius:8px;
    background: linear-gradient(180deg,#fff,#f3f5f7);
    border:1px solid rgba(3,7,18,0.03);
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .stamps .header { font-weight:800; font-size:16px; margin-bottom:6px; }
  .stamp-grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:12px;
    flex:1;
  }
  .stamp{
    min-height:130px;
    border-radius:8px;
    border:2px dashed rgba(0,0,0,0.07);
    background: repeating-linear-gradient(45deg, rgba(0,0,0,0.01) 0 10px, transparent 10px 20px);
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    padding:8px;
    font-weight:700;
    color:#4b5563;
  }

  /* when generating PDF, force A4 sizing via class */
  .a4-page{
    width:210mm;
    min-height:297mm;
    box-sizing:border-box;
  }

  /* page-break for html2pdf */
  .page-break{ page-break-after:always; }

  /* small notes */
  .note{ font-size:13px; color:#475569; margin-top:10px; }

  footer.controls-foot{ margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

  @media (max-width:900px){
    .layout{ flex-direction:column; }
    .preview-wrap{ order: -1; }
  }

</style>
</head>
<body>
  <h1>Floptropica Passport — PDF Generator</h1>
  <p class="lead">Fill the fields, upload your photo (required), optionally replace the coat-of-arms or flag images, preview and generate a multi-page PDF passport.</p>

  <div class="layout">
    <div class="controls" aria-label="Controls">
      <label>Full name (will appear in passport)</label>
      <input id="name" type="text" placeholder="e.g. Alex Flop" value="Alex Flop">

      <label>Date of birth</label>
      <input id="dob" type="date" value="2010-01-01">

      <label>Upload your passport photo (required)</label>
      <input id="photoInput" type="file" accept="image/*" />

      <label>Replace coat of arms (optional) — uses <code>coa.png</code> by default</label>
      <input id="coaInput" type="file" accept="image/*" />

      <label>Replace flag image 1 (optional) — uses <code>fl1.png</code></label>
      <input id="fl1Input" type="file" accept="image/*" />

      <label>Replace flag image 2 (optional) — uses <code>fl2.png</code></label>
      <input id="fl2Input" type="file" accept="image/*" />

      <div style="margin-top:12px;">
        <button class="btn" id="generate">Generate PDF</button>
        <button class="btn secondary" id="previewBtn" type="button">Update Preview</button>
      </div>

      <p class="note">Tip: place images named <code>coa.png</code>, <code>fl1.png</code>, <code>fl2.png</code> in the same folder to use by default, or upload replacements above.</p>
      <p class="note">The generator runs client-side and will not upload your picture to any server.</p>
    </div>

    <div class="preview-wrap">
      <div id="preview" class="passport-preview" aria-hidden="false">
        <!-- PAGE 1 - FRONT -->
        <div class="page front a4-page" id="page-front">
          <div class="top-left-flags">
            <img id="flag1" src="fl1.png" alt="flag1" onerror="this.style.display='none'">
            <img id="flag2" src="fl2.png" alt="flag2" onerror="this.style.display='none'">
          </div>

          <div class="coa-wrap">
            <img id="coaImg" src="coa.png" alt="coats of arms" onerror="this.style.display='none'">
          </div>

          <div class="front-footer">
            <div class="title">Republic of Floptropica Passport</div>
            <div class="mandarin">弗洛普特里卡共和国护照</div>
          </div>
        </div>

        <!-- PAGE 2 - INNER -->
        <div class="page inner a4-page" id="page-inner">
          <div class="bio">
            <div class="photo-box" title="Passport photo (uploaded)">
              <div id="photoPreview" class="photo"></div>
            </div>
            <div class="data">
              <div class="data-item">
                <div class="label">Name</div><div id="pv-name" class="value">Alex Flop</div>
              </div>
              <div class="data-item">
                <div class="label">DOB</div><div id="pv-dob" class="value">2010-01-01</div>
              </div>
              <div class="data-item">
                <div class="label">Nationality</div><div class="value">Floptropican</div>
              </div>
              <div class="data-item">
                <div class="label">Passport No.</div><div id="pv-passno" class="value">FLP-0000001</div>
              </div>
              <div style="margin-top:8px; font-size:12px; color:#6b7280;">Signature:</div>
              <div style="margin-top:6px; height:36px; border-bottom:2px dashed rgba(0,0,0,0.08)"></div>
            </div>
          </div>

          <div class="stamps">
            <div>
              <div class="header">Stamps & Visas</div>
              <div style="font-size:13px; color:#556075; margin-bottom:6px;">Official stamps and entry/exit marks.</div>
            </div>
            <div class="stamp-grid" id="stampGrid">
              <div class="stamp">STAMP</div>
              <div class="stamp">STAMP</div>
              <div class="stamp">STAMP</div>
              <div class="stamp">STAMP</div>
              <div class="stamp">STAMP</div>
              <div class="stamp">STAMP</div>
            </div>
            <div style="margin-top:10px; font-size:12px; color:#8b94a6;">Extras: You can print multiple PDFs with different stamps or edit the HTML to add custom stamp images.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // Elements
  const nameEl = document.getElementById('name');
  const dobEl = document.getElementById('dob');
  const pvName = document.getElementById('pv-name');
  const pvDob = document.getElementById('pv-dob');
  const pvPassNo = document.getElementById('pv-passno');

  const photoInput = document.getElementById('photoInput');
  const photoPreview = document.getElementById('photoPreview');

  const coaInput = document.getElementById('coaInput');
  const fl1Input = document.getElementById('fl1Input');
  const fl2Input = document.getElementById('fl2Input');

  const coaImg = document.getElementById('coaImg');
  const flag1 = document.getElementById('flag1');
  const flag2 = document.getElementById('flag2');

  // Helper to read file and return dataURL
  function readFileToDataURL(file){
    return new Promise((res, rej) => {
      if(!file) return res(null);
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = () => rej(new Error('File read error'));
      r.readAsDataURL(file);
    });
  }

  // Update preview fields
  function updatePreview(){
    const name = nameEl.value || '';
    const dob = dobEl.value || '';
    pvName.textContent = name;
    pvDob.textContent = dob;
    // Set a pseudo passport number from name + dob (simple)
    const passNo = 'FLP-' + (Math.random()*1e8|0).toString().padStart(7,'0');
    pvPassNo.textContent = passNo;
  }

  // Handle photo upload and set as background-image to preserve cover crop
  photoInput.addEventListener('change', async (ev) => {
    const file = ev.target.files[0];
    if(!file) return;
    const url = await readFileToDataURL(file);
    photoPreview.style.backgroundImage = `url('${url}')`;
    // ensure accessibility: remove any broken placeholder text
  });

  // Optional replacement images
  coaInput.addEventListener('change', async (ev) => {
    const f = ev.target.files[0];
    if(!f) return;
    const d = await readFileToDataURL(f);
    coaImg.src = d;
    coaImg.style.display = 'block';
  });
  fl1Input.addEventListener('change', async (ev) => {
    const f = ev.target.files[0];
    if(!f) return;
    const d = await readFileToDataURL(f);
    flag1.src = d;
    flag1.style.display = 'inline-block';
  });
  fl2Input.addEventListener('change', async (ev) => {
    const f = ev.target.files[0];
    if(!f) return;
    const d = await readFileToDataURL(f);
    flag2.src = d;
    flag2.style.display = 'inline-block';
  });

  // Update preview button
  document.getElementById('previewBtn').addEventListener('click', () => {
    updatePreview();
    alert('Preview updated — check the preview on the right.');
  });

  // Generate PDF
  document.getElementById('generate').addEventListener('click', async () => {
    // validation: require photo
    if(!photoInput.files || !photoInput.files[0]){
      alert('You must upload a passport photo before generating the PDF.');
      return;
    }

    updatePreview();

    // We'll create a clone of the preview and generate PDF from it, to control dimension and avoid UI interfering
    const preview = document.getElementById('preview');
    const clone = preview.cloneNode(true);

    // Ensure the clone uses the same background images from live preview
    // copy inline styles for the photoPreview background
    const srcPhotoBG = getComputedStyle(photoPreview).backgroundImage;
    const photoElClone = clone.querySelector('#photoPreview');
    if(photoElClone){
      photoElClone.style.backgroundImage = srcPhotoBG;
    }

    // Copy coa and flags if they were replaced
    const liveCoa = document.getElementById('coaImg');
    const liveFlag1 = document.getElementById('flag1');
    const liveFlag2 = document.getElementById('flag2');

    if(clone.querySelector('#coaImg') && liveCoa.src) clone.querySelector('#coaImg').src = liveCoa.src;
    if(clone.querySelector('#flag1') && liveFlag1.src) clone.querySelector('#flag1').src = liveFlag1.src;
    if(clone.querySelector('#flag2') && liveFlag2.src) clone.querySelector('#flag2').src = liveFlag2.src;

    // Remove control attributes (ids) inside clone to avoid duplicates, but leave class structure for styling
    clone.style.boxShadow = 'none';
    clone.style.margin = '0 auto';

    // Create a container for the pages we will pass to html2pdf
    const wrapper = document.createElement('div');
    wrapper.style.width = '210mm'; // A4 width
    wrapper.style.boxSizing = 'border-box';
    wrapper.appendChild(clone);

    // Create temporary off-screen container to render accurately (must be attached to DOM)
    const off = document.createElement('div');
    off.style.position = 'fixed';
    off.style.left = '-9999px';
    off.style.top = '0';
    off.style.width = '210mm';
    off.style.height = 'auto';
    off.appendChild(wrapper);
    document.body.appendChild(off);

    // html2pdf options
    const opt = {
      margin: [10, 10, 10, 10], // mm
      filename: (nameEl.value || 'floptropica_passport') + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2, // better resolution
        useCORS: true,
        logging: false,
        scrollY: 0
      },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak: { mode: ['css', 'legacy'] }
    };

    try {
      // Generate PDF
      await html2pdf().set(opt).from(wrapper).save();
    } catch (e) {
      console.error(e);
      alert('An error occurred while generating PDF. Check console for details.');
    } finally {
      // remove temporary container
      document.body.removeChild(off);
    }
  });

  // Initial preview population
  updatePreview();

  // If default images are missing, hide them gracefully
  coaImg.addEventListener('error', ()=> coaImg.style.display = 'none');
  flag1.addEventListener('error', ()=> flag1.style.display = 'none');
  flag2.addEventListener('error', ()=> flag2.style.display = 'none');

})();
</script>
</body>
</html>